{% extends "dashboard/admin/base_admin.html" %} {% block dashboard_content %}

<div class="flex flex-col items-center mb-8">
  <span class="text-6xl mb-2">üë®‚Äç‚öïÔ∏è</span>
  <h1 class="text-3xl font-extrabold text-blue-800 mb-2">Manage Doctors</h1>
  <p class="text-lg text-blue-700 text-center">
    View and manage registered doctors. You can remove accounts if necessary.
  </p>
</div>

<div class="bg-white rounded-2xl shadow p-6 w-full">
  <h2 class="text-xl font-bold text-blue-800 mb-4">Doctors</h2>

  <!-- Scrollable table container -->
  <div class="overflow-x-auto w-full">
    <table class="min-w-full border border-gray-200 rounded-lg table-auto">
      <thead class="bg-blue-100 text-blue-900">
        <tr>
          <th class="px-4 py-2 text-left">ID</th>
          <th class="px-4 py-2 text-left">Username</th>
          <th class="px-4 py-2 text-left">First Name</th>
          <th class="px-4 py-2 text-left">Last Name</th>
          <th class="px-4 py-2 text-left">Email</th>
          <th class="px-4 py-2 text-left">Specialization</th>
          <th class="px-4 py-2 text-left">Approval Status</th>
          <th class="px-4 py-2 text-left">Date Joined</th>
          <th class="px-4 py-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for doctor in doctors %}
        <tr class="border-b hover:bg-blue-50">
          <td class="px-4 py-2">{{ doctor.id }}</td>

          <!-- Username with truncate -->
          <td
            class="px-4 py-2 truncate max-w-[120px]"
            title="{{ doctor.username }}"
          >
            {{ doctor.username }}
          </td>

          <td class="px-4 py-2">{{ doctor.first_name|default:"-" }}</td>
          <td class="px-4 py-2">{{ doctor.last_name|default:"-" }}</td>

          <!-- Email with truncate -->
          <td
            class="px-4 py-2 truncate max-w-[180px]"
            title="{{ doctor.email }}"
          >
            {{ doctor.email }}
          </td>

          <!-- Specialization with truncate -->
          <td
            class="px-4 py-2 truncate max-w-[200px]"
            title="{{ doctor.doctor_profile.specialization }}"
          >
            {{ doctor.doctor_profile.specialization|default:"-" }}
          </td>

          <!-- Approval Status -->
          <td class="px-4 py-2">
            {% if doctor.doctor_profile.is_approved %}
            <span
              class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium"
            >
              ‚úÖ Approved
            </span>
            {% else %}
            <span
              class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium"
            >
              ‚è≥ Pending
            </span>
            {% endif %}
          </td>

          <td class="px-4 py-2">{{ doctor.date_joined|date:"F j, Y" }}</td>

          <!-- Actions -->
          <td class="px-4 py-2">
            {% if not doctor.doctor_profile.is_approved %}
            <button
              data-doctor-id="{{ doctor.id }}"
              data-doctor-name="{{ doctor.first_name|default:doctor.username|escapejs }}"
              class="approve-doctor-btn px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition mr-2"
            >
              Approve
            </button>
            {% endif %}
            <button
              data-doctor-id="{{ doctor.id }}"
              data-doctor-name="{{ doctor.first_name|default:doctor.username|escapejs }}"
              class="delete-doctor-btn px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition"
            >
              Delete
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center py-4 text-gray-500">
            No doctors found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  id="deleteModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
>
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-lg font-bold text-gray-800 mb-4">Confirm Delete</h3>
    <p id="deleteMessage" class="text-gray-700 mb-6"></p>
    <div class="flex gap-3">
      <button
        onclick="closeDeleteModal()"
        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
      >
        Cancel
      </button>
      <button
        id="confirmDeleteBtn"
        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
      >
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Approve Confirmation Modal -->
<div
  id="approveModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
>
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-lg font-bold text-gray-800 mb-4">Confirm Approval</h3>
    <p id="approveMessage" class="text-gray-700 mb-6"></p>
    <div class="flex gap-3">
      <button
        onclick="closeApproveModal()"
        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
      >
        Cancel
      </button>
      <button
        id="confirmApproveBtn"
        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
      >
        Approve
      </button>
    </div>
  </div>
</div>

<!-- Success/Error Message -->
<div id="messageContainer" class="fixed top-4 right-4 z-50 hidden">
  <div
    id="messageContent"
    class="px-6 py-3 rounded-lg shadow-lg text-white"
  ></div>
</div>

<script>
  let currentDeleteId = null;
  let currentDeleteType = null;
  let currentApproveId = null;
  let currentApproveName = null;

  function confirmDeleteDoctor(doctorId, doctorName) {
    currentDeleteId = doctorId;
    currentDeleteType = "doctor";
    document.getElementById(
      "deleteMessage"
    ).textContent = `Are you sure you want to delete doctor "${doctorName}"? This action cannot be undone.`;
    document.getElementById("deleteModal").classList.remove("hidden");
    document.getElementById("deleteModal").classList.add("flex");
  }

  function confirmDeleteFarmer(farmerId, farmerName) {
    currentDeleteId = farmerId;
    currentDeleteType = "farmer";
    document.getElementById(
      "deleteMessage"
    ).textContent = `Are you sure you want to delete farmer "${farmerName}"? This action cannot be undone.`;
    document.getElementById("deleteModal").classList.remove("hidden");
    document.getElementById("deleteModal").classList.add("flex");
  }

  function confirmApproveDoctor(doctorId, doctorName) {
    currentApproveId = doctorId;
    currentApproveName = doctorName;
    document.getElementById(
      "approveMessage"
    ).textContent = `Are you sure you want to approve doctor "${doctorName}"? This will grant them full access to all doctor features.`;
    document.getElementById("approveModal").classList.remove("hidden");
    document.getElementById("approveModal").classList.add("flex");
  }

  function approveDoctor(doctorId, doctorName) {
    fetch(`/admin-panel/approve/doctor/${doctorId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        closeApproveModal();
        if (data.success) {
          showMessage(data.message, true);
          // Reload page after successful approval
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          showMessage(data.message, false);
        }
      })
      .catch((error) => {
        closeApproveModal();
        showMessage(
          "An error occurred while approving. Please try again.",
          false
        );
      });
  }

  function closeDeleteModal() {
    document.getElementById("deleteModal").classList.add("hidden");
    document.getElementById("deleteModal").classList.remove("flex");
    currentDeleteId = null;
    currentDeleteType = null;
  }

  function closeApproveModal() {
    document.getElementById("approveModal").classList.add("hidden");
    document.getElementById("approveModal").classList.remove("flex");
    currentApproveId = null;
    currentApproveName = null;
  }

  function showMessage(message, isSuccess = true) {
    const container = document.getElementById("messageContainer");
    const content = document.getElementById("messageContent");

    content.textContent = message;
    content.className = `px-6 py-3 rounded-lg shadow-lg text-white ${
      isSuccess ? "bg-green-600" : "bg-red-600"
    }`;

    container.classList.remove("hidden");
    container.classList.add("block");

    setTimeout(() => {
      container.classList.add("hidden");
      container.classList.remove("block");
    }, 3000);
  }

  // Add event listeners when DOM is loaded
  document.addEventListener("DOMContentLoaded", function () {
    // Set up confirm delete button
    document
      .getElementById("confirmDeleteBtn")
      .addEventListener("click", function () {
        if (currentDeleteId && currentDeleteType) {
          const url =
            currentDeleteType === "doctor"
              ? `/admin-panel/delete/doctor/${currentDeleteId}/`
              : `/admin-panel/delete/farmer/${currentDeleteId}/`;

          fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              closeDeleteModal();
              if (data.success) {
                showMessage(data.message, true);
                // Reload page after successful delete
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              } else {
                showMessage(data.message, false);
              }
            })
            .catch((error) => {
              closeDeleteModal();
              showMessage(
                "An error occurred while deleting. Please try again.",
                false
              );
            });
        }
      });

    // Close modal when clicking outside
    document
      .getElementById("deleteModal")
      .addEventListener("click", function (e) {
        if (e.target === this) {
          closeDeleteModal();
        }
      });

    // Add event listeners for delete doctor buttons
    document.querySelectorAll(".delete-doctor-btn").forEach(function (button) {
      button.addEventListener("click", function () {
        const doctorId = this.getAttribute("data-doctor-id");
        const doctorName = this.getAttribute("data-doctor-name");
        console.log("Delete doctor button clicked:", doctorId, doctorName);
        confirmDeleteDoctor(doctorId, doctorName);
      });
    });

    // Add event listeners for approve doctor buttons
    document.querySelectorAll(".approve-doctor-btn").forEach(function (button) {
      button.addEventListener("click", function () {
        const doctorId = this.getAttribute("data-doctor-id");
        const doctorName = this.getAttribute("data-doctor-name");
        console.log("Approve doctor button clicked:", doctorId, doctorName);
        confirmApproveDoctor(doctorId, doctorName);
      });
    });

    // Set up confirm approve button
    document
      .getElementById("confirmApproveBtn")
      .addEventListener("click", function () {
        if (currentApproveId) {
          approveDoctor(currentApproveId, currentApproveName);
        }
      });

    // Close modal when clicking outside
    document
      .getElementById("approveModal")
      .addEventListener("click", function (e) {
        if (e.target === this) {
          closeApproveModal();
        }
      });
  });
</script>

{% endblock %}
